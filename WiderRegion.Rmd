---
title: "Extended Area Mounds"
author: "Adela Sobotkova"
date: "2024-06-05"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(sf)
library(raster)
library(tidyverse)
library(mapview)
```

## Load Yambol mounds
```{r}
# Yambol mounds
Yam_mnds <- readRDS("data/Yam_dd_mnds.rds") # 1073 features
Yam_mnds %>% 
  group_by(Type) %>% 
  tally()
```

## Load Mounds from Wider Area

```{r}
# rasters
#YT_elev <- raster("data/large/YT_elev32635.tif") # vertical
Y35 <- raster("data/large/Y_elev_ext.tif") # horizontal

# region admin
region <- read_sf("data/YamRegion.shp")
Y_buf25 <- st_buffer(region, 25000)

# map mounds ~ 10,000 points
m_all <- read_sf("data/MapMounds32635.shp")
m_all %>% group_by(MpSymbl) %>% tally()

# filter the most conservative symbol (sunburst) 4290 points
mm <- m_all %>% 
    filter(grepl("^Hairy brown", MpSymbl)) # deleting 'brown' gets all rayed symbols


```

### Northern map mounds Angel digitized in June 2024
this concerns mounds north of Yambol - mostly in Stara Planina -  that fall within 25 km buffer of Yambol border 
```{r}
mm_a <- read_sf("../YambolMoundAnalysis2023/data/MapMoundsA32635.geojson")
mm_a$Notes <- ""
mm <- mm %>% 
  rename(Id =identfr, createdBy=cretdBy, createdAt = FtrTmst,Latitude = Latitud, Longitude = Longitd, MapSymbol = MpSymbl, Notes = Note) %>% 
  dplyr::select(Id, createdBy, createdAt, Latitude, Longitude, MapSymbol, Notes) %>% 
  rbind(mm_a)

```

### Intersect map mounds with 25 km buffer of Yambol region
```{r}
# intersect filtered sunbursts with region buffer
mm_Yext <- st_intersection(mm, (Y_buf25$geometry %>% 
  st_difference(region$geometry)))

# are there duplicate IDs in the 1065 map mounds?
mm_Yext %>% 
  group_by(Id) %>% 
  count() %>% arrange(desc(n))

# save intermediate products
st_write(mm_Yext, "output_data/Y25_mapmounds.shp", append = F)
#st_write(Y_buf25, "data/Y_region_buf25k.shp")


# Visualize additional mounds and their relief
plot(Y_buf25$geometry, border = "red");plot(mm_Yext$geometry, add = T);plot(region$geometry, add =T, col = "green")

plot(Y35, main = "Digitized map mounds within 25km buffer of Yambol Province");plot(region$geometry, add =T);plot(mm_Yext$geometry, add = T)

mapview(Y35)+ mapview(mm_Yext)+mapview(region)
hist(values(Y35))
```


## Prepare Map Mounds for Intervisibility

### Focus on mounds on edges
Calculate intervisibility for origin mounds among those 5 km to the border and the mapped mound and then add this result to the current intervisibility table. How many mounds outside Yambol can these mounds see?

```{r}
innerbuff <- st_buffer(region, -5000)
edge5km_mounds <- st_difference(Yam_mnds, innerbuff)

# SOUTHERN BORDER IS INTRACTABLE..so skipping mounds within 4500m of border 
edge5km_mounds<- edge5km_mounds %>% 
  filter(unclass(distBG) >4500) 

plot(region$geometry);plot(innerbuff, add = T)
plot(edge5km_mounds$geometry, add = T)

```

```{r inter-prep}
# origin point coordinates and height
Yam_mnds$HeightMax[is.na(Yam_mnds$HeightMax)] <- 0
origin <- cbind(st_coordinates(Yam_mnds), h = Yam_mnds$HeightMax)

# MUST HAVE NON-NA HEIGHT
edge5km_mounds$HeightMax[is.na(edge5km_mounds$HeightMax)] <- 0
origin <- cbind(st_coordinates(edge5km_mounds), h = edge5km_mounds$HeightMax)

# target points in map mounds
target <- cbind(st_coordinates(mm_Yext), h = 2) 
#plot(Y35); plot(mm_Yext$geometry, add = T);plot(edge5km_mounds$geometry, add = T, col = "red")


class(origin)
class(target)

rm(mm,m_all, innerbuff)
```



## Activate the functions needed
```{r}
source("scripts/VisibilityFunctions.R")
```

## Parallelize!
Parallelisation is much faster than loops but still takes ca 6-12 hours for the whole dataset of 1000 by 1000 mounds. Run if needed
```{r auto-foreach, eval = FALSE}
# install.packages("doParallel")
# install.packages("foreach")
library(foreach)
library(doParallel)
library(data.table)

detectCores() # 22 as some are multi-threaded
detectCores(logical = FALSE) # 16 real ones

cl <- makeCluster(10) # keep 4 cores so screensaver can run on W11; lowering to 10
registerDoParallel(cl)

on.exit({
  try({
   cat("Attempting to stop cluster\n")
   ?stopImplicitCluster()        # package: `doParallel`
   })
 })

# Start experiment
dim(origin) 
dim(target) 

# FOR TESTING PURPOSES REDUCE THE SIZE!
origin <- origin[1:20,] # 10, 100 out of 341
#target <- target[1:600,]  # half of 1206 works for smaller datasets! Halve the current size

# nesting both i and e with foreach 
ie_table <- foreach (i= 1:nrow(origin), # reduce the load instead of 1073 in nrow(origin)
                     .combine = 'rbind',
                     .packages = c("data.table", "raster")) %do% {  
  print(i)
  foreach( e= 1:nrow(target), .combine = 'rbind',.packages = c("data.table", "raster")) %dopar% {
  print(e)
  result <-  cansee(Y35, origin[i,1:2], target[e,1:2], h1 = origin[i,3], h2 = target[e,3])
  result_row <- c(i,e, result)
  }
}

# tell R that we don't need the processes anymore
stopCluster(cl)


dim(ie_table) # 1,151,329 calculations take ~12 hours (10x less than for loop) 
head(ie_table, n =20)

saveRDS(ie_table, "output_data/Yam_10ext_mnds_intervis.rds") # 10 * 1200 calculations worked, 5000 were NA
rm(ie_table)

```

```{r}
res <- as_tibble(ie_table)
res %>% 
  filter(!is.na(V3))

result_table <- res %>% 
  rename(i = V1, e = V2, visibility = V3)
result_table %>% 
  filter(visibility ==1)

result_table$TRAPorigin <- edge5km_mounds$TRAP[result_table$i]
result_table$TRAPtarget <- mm_Yext$Id[result_table$e]

result_table %>%  
  group_by(TRAPorigin) %>% 
  tally(visibility) %>% 
  arrange(desc(n)) %>% 
  left_join(edge5km_mounds, by = c("TRAPorigin"="TRAP")) %>%
  st_as_sf(crs = 32635) %>% 
  mapview(cex = "n" , zcol = "HeightMax") +mapview(Yam_mnds,cex = 0.1) 
  
```

